<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - Zunto</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-dark: #050d1b; --primary-blue: #2c77d1; --primary-purple: #9426f4;
            --text-light: #ffffff; --text-gray: #a0aec0; --bg-dark: #0a1628; --card-bg: #1a2332;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--primary-dark); color: var(--text-light); line-height: 1.6; }
        header { background: linear-gradient(135deg, var(--primary-dark) 0%, var(--bg-dark) 100%); padding: 1rem 0; box-shadow: 0 4px 20px rgba(148, 38, 244, 0.2); position: sticky; top: 0; z-index: 100; }
        nav { max-width: 1400px; margin: 0 auto; padding: 0 2rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 2rem; font-weight: bold; background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; cursor: pointer; }
        .nav-links { display: flex; gap: 2rem; }
        .nav-links a { color: var(--text-light); text-decoration: none; transition: color 0.3s; }
        .nav-links a:hover { color: var(--primary-blue); }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .page-title { font-size: 2.5rem; background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; }
        .page-subtitle { color: var(--text-gray); font-size: 1.1rem; margin-bottom: 2rem; }
        .filter-tabs { display: flex; gap: 1rem; margin-bottom: 2rem; overflow-x: auto; }
        .filter-tab { background: var(--card-bg); color: var(--text-gray); padding: 0.75rem 1.5rem; border: 2px solid transparent; border-radius: 50px; cursor: pointer; white-space: nowrap; transition: all 0.3s; }
        .filter-tab:hover { border-color: var(--primary-blue); }
        .filter-tab.active { background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple)); color: white; }
        .tab-badge { background: rgba(255, 255, 255, 0.2); padding: 0.25rem 0.5rem; border-radius: 10px; font-size: 0.85rem; margin-left: 0.5rem; }
        .order-card { background: var(--card-bg); border-radius: 20px; margin-bottom: 1.5rem; border: 2px solid transparent; transition: all 0.3s; }
        .order-card:hover { border-color: var(--primary-blue); box-shadow: 0 10px 30px rgba(44, 119, 209, 0.2); }
        .order-header { background: var(--bg-dark); padding: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; border-bottom: 2px solid var(--card-bg); }
        .info-label { color: var(--text-gray); font-size: 0.85rem; text-transform: uppercase; }
        .info-value { font-size: 1.1rem; font-weight: 600; margin-top: 0.25rem; }
        .order-number { color: var(--primary-blue); }
        .status-badge { display: inline-block; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600; text-transform: uppercase; }
        .status-pending { background: rgba(251, 191, 36, 0.2); color: #fbbf24; border: 2px solid #fbbf24; }
        .status-processing { background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 2px solid #3b82f6; }
        .status-shipped { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; border: 2px solid #8b5cf6; }
        .status-delivered { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 2px solid #10b981; }
        .status-cancelled { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 2px solid #ef4444; }
        .order-items { padding: 1.5rem; }
        .order-item { display: grid; grid-template-columns: 80px 1fr auto; gap: 1rem; padding: 1rem; background: var(--bg-dark); border-radius: 10px; margin-bottom: 1rem; }
        .item-image { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
        .item-name { font-weight: 600; }
        .item-meta { color: var(--text-gray); font-size: 0.9rem; }
        .item-total { font-size: 1.3rem; font-weight: bold; color: var(--primary-blue); }
        .item-qty { color: var(--text-gray); font-size: 0.9rem; }
        .order-footer { background: var(--bg-dark); padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; border-top: 2px solid var(--card-bg); }
        .total-label { color: var(--text-gray); font-size: 0.9rem; }
        .total-amount { font-size: 2rem; font-weight: bold; color: var(--primary-blue); }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple)); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(148, 38, 244, 0.4); }
        .btn-danger { background: transparent; color: #ef4444; border: 2px solid #ef4444; }
        .btn-danger:hover { background: #ef4444; color: white; }
        .empty-state { text-align: center; padding: 4rem 2rem; background: var(--card-bg); border-radius: 20px; }
        .empty-icon { font-size: 5rem; margin-bottom: 1rem; opacity: 0.5; }
        .loading { text-align: center; padding: 3rem; }
        .spinner { border: 4px solid var(--card-bg); border-top: 4px solid var(--primary-blue); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) {
            .order-header { grid-template-columns: 1fr; }
            .order-item { grid-template-columns: 60px 1fr; }
            .order-footer { flex-direction: column; gap: 1rem; }
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="logo" onclick="window.location.href='/'">Zunto</div>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/account.html">Account</a>
                <a href="/orders.html" style="color: var(--primary-blue);">My Orders</a>
            </div>
        </nav>
    </header>
    <div class="container">
        <h1 class="page-title">My Orders</h1>
        <p class="page-subtitle">Track and manage your orders</p>
        <div class="filter-tabs">
            <div class="filter-tab active" onclick="filterOrders('all')">All<span class="tab-badge" id="badge-all">0</span></div>
            <div class="filter-tab" onclick="filterOrders('pending')">‚è≥ Pending<span class="tab-badge" id="badge-pending">0</span></div>
            <div class="filter-tab" onclick="filterOrders('processing')">üì¶ Processing<span class="tab-badge" id="badge-processing">0</span></div>
            <div class="filter-tab" onclick="filterOrders('shipped')">üöö Shipped<span class="tab-badge" id="badge-shipped">0</span></div>
            <div class="filter-tab" onclick="filterOrders('delivered')">‚úÖ Delivered<span class="tab-badge" id="badge-delivered">0</span></div>
            <div class="filter-tab" onclick="filterOrders('cancelled')">‚ùå Cancelled<span class="tab-badge" id="badge-cancelled">0</span></div>
        </div>
        <div id="ordersList">
            <div class="loading"><div class="spinner"></div><p style="margin-top: 1rem; color: var(--text-gray);">Loading orders...</p></div>
        </div>
    </div>
    <script>
        const API_BASE_URL = '/api';
        let allOrders = [];
        let currentFilter = 'all';
        
        document.addEventListener('DOMContentLoaded', loadOrders);
        
        async function loadOrders() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) { window.location.href = '/login.html?redirect=orders'; return; }
                const response = await fetch(`${API_BASE_URL}/orders/my-orders/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 401) { localStorage.removeItem('authToken'); window.location.href = '/login.html?redirect=orders'; return; }
                const data = await response.json();
                allOrders = Array.isArray(data) ? data : (data.results || []);
                updateBadges();
                renderOrders();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('ordersList').innerHTML = '<div class="empty-state"><div class="empty-icon">‚ùå</div><h2>Error Loading Orders</h2><button class="btn btn-primary" onclick="loadOrders()">Retry</button></div>';
            }
        }
        
        function updateBadges() {
            ['all', 'pending', 'processing', 'shipped', 'delivered', 'cancelled'].forEach(s => {
                const count = s === 'all' ? allOrders.length : allOrders.filter(o => o.status === s).length;
                document.getElementById(`badge-${s}`).textContent = count;
            });
        }
        
        function filterOrders(status) {
            currentFilter = status;
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            event.target.closest('.filter-tab').classList.add('active');
            renderOrders();
        }
        
        function renderOrders() {
            const filtered = currentFilter === 'all' ? allOrders : allOrders.filter(o => o.status === currentFilter);
            const container = document.getElementById('ordersList');
            if (!filtered.length) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üì¶</div><h2>No orders found</h2><button class="btn btn-primary" onclick="window.location.href=\'/\'">Start Shopping</button></div>';
                return;
            }
            container.innerHTML = filtered.map(o => {
                const date = new Date(o.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                return `<div class="order-card">
                    <div class="order-header">
                        <div><div class="info-label">Order Number</div><div class="info-value order-number">#${o.order_number}</div></div>
                        <div><div class="info-label">Date</div><div class="info-value">${date}</div></div>
                        <div><div class="info-label">Status</div><span class="status-badge status-${o.status}">${o.status}</span></div>
                        <div><div class="info-label">Items</div><div class="info-value">${o.total_items || 0}</div></div>
                    </div>
                    <div class="order-items" id="items-${o.id}"><div class="loading" style="padding:1rem;"><div class="spinner" style="width:30px;height:30px;"></div></div></div>
                    <div class="order-footer">
                        <div><div class="total-label">Total</div><div class="total-amount">‚Ç¶${parseFloat(o.total_amount).toLocaleString()}</div></div>
                        <div style="display:flex;gap:1rem;">
                            <a href="/order-detail.html?order=${o.order_number}" class="btn btn-primary">View Details</a>
                            ${o.can_cancel ? `<button class="btn btn-danger" onclick="cancelOrder('${o.order_number}')">Cancel</button>` : ''}
                        </div>
                    </div>
                </div>`;
            }).join('');
            filtered.forEach(o => loadOrderItems(o.id, o.order_number));
        }
        
        async function loadOrderItems(id, num) {
            try {
                const token = localStorage.getItem('authToken');
                const res = await fetch(`${API_BASE_URL}/orders/orders/${num}/`, { headers: { 'Authorization': `Bearer ${token}` } });
                const order = await res.json();
                const el = document.getElementById(`items-${id}`);
                if (order.items?.length) {
                    el.innerHTML = order.items.slice(0, 3).map(i => `<div class="order-item">
                        <img src="${i.product_image || 'https://via.placeholder.com/80'}" class="item-image">
                        <div><div class="item-name">${i.product_name}</div><div class="item-meta">Qty: ${i.quantity}</div></div>
                        <div style="text-align:right;"><div class="item-total">‚Ç¶${parseFloat(i.total_price).toLocaleString()}</div></div>
                    </div>`).join('') + (order.items.length > 3 ? `<p style="text-align:center;color:var(--text-gray);padding:1rem;">+${order.items.length-3} more</p>` : '');
                }
            } catch (e) { console.error(e); }
        }
        
        async function cancelOrder(num) {
            if (!confirm('Cancel this order?')) return;
            const reason = prompt('Reason:');
            if (!reason) return;
            try {
                const token = localStorage.getItem('authToken');
                const res = await fetch(`${API_BASE_URL}/orders/orders/${num}/cancel/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });
                if (res.ok) { alert('‚úÖ Cancelled'); loadOrders(); }
                else { alert('‚ùå Failed'); }
            } catch (e) { alert('‚ùå Error'); }
        }
    </script>
</body>
</html>
