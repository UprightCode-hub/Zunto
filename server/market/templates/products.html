<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products - Zunto</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-dark: #050d1b;
            --primary-blue: #2c77d1;
            --primary-purple: #9426f4;
            --text-light: #ffffff;
            --text-gray: #a0aec0;
            --bg-dark: #0a1628;
            --card-bg: #1a2332;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-dark);
            color: var(--text-light);
            line-height: 1.6;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--bg-dark) 100%);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(148, 38, 244, 0.2);
        }

        nav {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            color: var(--text-light);
            text-decoration: none;
            transition: color 0.3s;
            font-weight: 500;
        }

        .nav-links a:hover {
            color: var(--primary-blue);
        }

        .search-bar {
            flex: 1;
            max-width: 500px;
            margin: 0 2rem;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 0.75rem 3rem 0.75rem 1rem;
            background: var(--card-bg);
            border: 2px solid transparent;
            border-radius: 50px;
            color: var(--text-light);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 20px rgba(44, 119, 209, 0.3);
        }

        .search-btn {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .search-btn:hover {
            transform: translateY(-50%) scale(1.05);
        }

        .user-actions {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .icon-btn {
            background: var(--card-bg);
            border: none;
            padding: 0.75rem;
            border-radius: 50%;
            color: var(--text-light);
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            background: var(--primary-blue);
            transform: translateY(-2px);
        }

        .cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--primary-purple);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Breadcrumb */
        .breadcrumb {
            color: var(--text-gray);
            margin-bottom: 2rem;
        }

        .breadcrumb a {
            color: var(--primary-blue);
            text-decoration: none;
        }

        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .view-toggle {
            display: flex;
            gap: 0.5rem;
            background: var(--card-bg);
            padding: 0.5rem;
            border-radius: 10px;
        }

        .view-btn {
            background: transparent;
            border: none;
            color: var(--text-gray);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-btn.active {
            background: var(--primary-blue);
            color: white;
        }

        /* Layout */
        .products-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 2rem;
        }

        /* Filters Sidebar */
        .filters-sidebar {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 20px;
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .filter-section {
            margin-bottom: 2rem;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--bg-dark);
        }

        .filter-title {
            font-weight: 600;
            color: var(--text-light);
        }

        .clear-filter {
            background: none;
            border: none;
            color: var(--primary-blue);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .clear-filter:hover {
            color: var(--primary-purple);
        }

        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .filter-option:hover {
            background: var(--bg-dark);
        }

        .filter-option input[type="checkbox"],
        .filter-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .filter-option label {
            flex: 1;
            cursor: pointer;
            color: var(--text-gray);
        }

        .filter-count {
            color: var(--text-gray);
            font-size: 0.85rem;
        }

        /* Price Range Slider */
        .price-range {
            margin-top: 1rem;
        }

        .price-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .price-input {
            background: var(--bg-dark);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 0.5rem;
            color: var(--text-light);
            width: 100%;
        }

        .price-input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .price-slider {
            width: 100%;
            height: 6px;
            background: var(--bg-dark);
            border-radius: 5px;
            outline: none;
        }

        /* Rating Filter */
        .rating-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stars {
            color: #fbbf24;
        }

        /* Apply Filters Button */
        .apply-filters {
            width: 100%;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
            color: white;
            padding: 0.875rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1rem;
        }

        .apply-filters:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(148, 38, 244, 0.4);
        }

        /* Products Section */
        .products-section {
            min-height: 500px;
        }

        .results-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--card-bg);
            border-radius: 12px;
        }

        .results-count {
            color: var(--text-gray);
        }

        .sort-options {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sort-select {
            background: var(--bg-dark);
            color: var(--text-light);
            border: 2px solid transparent;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
        }

        .sort-select:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        /* Active Filters */
        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .filter-tag {
            background: var(--card-bg);
            color: var(--text-light);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .remove-filter {
            background: none;
            border: none;
            color: var(--primary-purple);
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .product-grid.list-view {
            grid-template-columns: 1fr;
        }

        .product-card {
            background: var(--card-bg);
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            border: 2px solid transparent;
        }

        .product-card:hover {
            transform: translateY(-10px);
            border-color: var(--primary-blue);
            box-shadow: 0 10px 40px rgba(44, 119, 209, 0.3);
        }

        .product-card.list-view {
            display: grid;
            grid-template-columns: 200px 1fr auto;
            gap: 1.5rem;
        }

        .product-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            background: linear-gradient(135deg, #1a2332 0%, #0a1628 100%);
        }

        .product-card.list-view .product-image {
            height: 200px;
            width: 200px;
        }

        .product-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--primary-purple);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            z-index: 10;
        }

        .wishlist-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(10, 22, 40, 0.8);
            border: none;
            padding: 0.5rem;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
        }

        .wishlist-btn:hover {
            background: var(--primary-purple);
            transform: scale(1.1);
        }

        .product-info {
            padding: 1.5rem;
        }

        .product-card.list-view .product-info {
            padding: 1rem;
        }

        .product-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-light);
        }

        .product-category {
            color: var(--text-gray);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .product-location {
            color: var(--text-gray);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .product-rating {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .review-count {
            color: var(--text-gray);
            font-size: 0.9rem;
        }

        .product-price {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-blue);
            margin-bottom: 1rem;
        }

        .negotiable-tag {
            color: var(--text-gray);
            font-size: 0.85rem;
        }

        .product-actions {
            display: flex;
            gap: 0.5rem;
        }

        .add-to-cart {
            flex: 1;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
            color: white;
            padding: 0.75rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .add-to-cart:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(148, 38, 244, 0.4);
        }

        .quick-view {
            background: var(--bg-dark);
            color: white;
            padding: 0.75rem 1rem;
            border: 2px solid var(--primary-blue);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-view:hover {
            background: var(--primary-blue);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 3rem;
        }

        .page-btn {
            background: var(--card-bg);
            color: var(--text-light);
            border: 2px solid transparent;
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .page-btn:hover {
            border-color: var(--primary-blue);
        }

        .page-btn.active {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
            border-color: var(--primary-purple);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 3rem;
        }

        .spinner {
            border: 4px solid var(--card-bg);
            border-top: 4px solid var(--primary-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: var(--card-bg);
            border-radius: 20px;
        }

        .empty-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
        }

        .empty-state h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .empty-state p {
            color: var(--text-gray);
            margin-bottom: 2rem;
        }

        /* Mobile Filters */
        .mobile-filter-btn {
            display: none;
            width: 100%;
            background: var(--primary-blue);
            color: white;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 1rem;
        }

        .filters-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9998;
        }

        .filters-overlay.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .products-layout {
                grid-template-columns: 1fr;
            }

            .filters-sidebar {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                width: 320px;
                z-index: 9999;
                overflow-y: auto;
            }

            .filters-sidebar.active {
                display: block;
            }

            .mobile-filter-btn {
                display: block;
            }

            .close-filters {
                display: block;
                width: 100%;
                background: var(--bg-dark);
                color: white;
                padding: 1rem;
                border: none;
                border-radius: 12px;
                cursor: pointer;
                margin-bottom: 1rem;
            }
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .search-bar {
                max-width: 300px;
                margin: 0 1rem;
            }

            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 1rem;
            }

            .product-card.list-view {
                grid-template-columns: 1fr;
            }

            .results-bar {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <nav>
             <div class="logo" onclick="window.location.href='{% url 'product_list_page' %}">Zunto</div>
            <ul class="nav-links">
                <li><a href="{% url 'product_list_page' %}">Home</a></li>
                <li><a href="{% url 'product_list' %}" class="active">Products</a></li>
                <li><a href="{% url 'category_list' %}">Categories</a></li>
                <li><a href="{% url 'deals' %}">Deals</a></li>
            </ul>

            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search products...">
                <button class="search-btn" onclick="performSearch()">üîç</button>
            </div>

            <div class="user-actions">
                <button class="icon-btn" onclick="window.location.href='{% url 'favorite_list' %}'">
                    ‚ù§Ô∏è
                </button>
                <button class="icon-btn" onclick="window.location.href='{% url 'cart' %}'">
                    üõí
                    <span class="cart-badge" id="cartCount">0</span>
                </button>
                <button class="icon-btn" onclick="toggleUserMenu()">
                    üë§
                </button>
            </div>
        </nav>
    </header>

    <div class="container">
        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <a href="{% url 'home' %}">Home</a> / <span id="breadcrumbText">Products</span>
        </div>

        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title" id="pageTitle">All Products</h1>
            <div class="view-toggle">
                <button class="view-btn active" onclick="setView('grid')">
                    ‚äû Grid
                </button>
                <button class="view-btn" onclick="setView('list')">
                    ‚ò∞ List
                </button>
            </div>
        </div>

        <!-- Mobile Filter Button -->
        <button class="mobile-filter-btn" onclick="toggleMobileFilters()">
            üîç Filters & Sort
        </button>

        <!-- Filters Overlay (Mobile) -->
        <div class="filters-overlay" id="filtersOverlay" onclick="toggleMobileFilters()"></div>

        <!-- Main Layout -->
        <div class="products-layout">
            <!-- Filters Sidebar -->
            <aside class="filters-sidebar" id="filtersSidebar">
                <button class="close-filters" onclick="toggleMobileFilters()" style="display: none;">
                    ‚úï Close Filters
                </button>

                <!-- Category Filter -->
                <div class="filter-section">
                    <div class="filter-header">
                        <span class="filter-title">Categories</span>
                        <button class="clear-filter" onclick="clearFilter('category')">Clear</button>
                    </div>
                    <div class="filter-options" id="categoryFilters">
                        <!-- Loaded dynamically -->
                    </div>
                </div>

                <!-- Location Filter -->
                <div class="filter-section">
                    <div class="filter-header">
                        <span class="filter-title">Location</span>
                        <button class="clear-filter" onclick="clearFilter('location')">Clear</button>
                    </div>
                    <div class="filter-options" id="locationFilters">
                        <!-- Loaded dynamically -->
                    </div>
                </div>

                <!-- Price Range -->
                <div class="filter-section">
                    <div class="filter-header">
                        <span class="filter-title">Price Range</span>
                        <button class="clear-filter" onclick="clearFilter('price')">Clear</button>
                    </div>
                    <div class="price-range">
                        <div class="price-inputs">
                            <input type="number" class="price-input" id="minPrice" placeholder="Min ‚Ç¶">
                            <input type="number" class="price-input" id="maxPrice" placeholder="Max ‚Ç¶">
                        </div>
                    </div>
                </div>

                <!-- Condition Filter -->
                <div class="filter-section">
                    <div class="filter-header">
                        <span class="filter-title">Condition</span>
                        <button class="clear-filter" onclick="clearFilter('condition')">Clear</button>
                    </div>
                    <div class="filter-options">
                        <div class="filter-option">
                            <input type="checkbox" id="cond_new" value="new">
                            <label for="cond_new">New</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="cond_like_new" value="like_new">
                            <label for="cond_like_new">Like New</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="cond_good" value="good">
                            <label for="cond_good">Good</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="cond_fair" value="fair">
                            <label for="cond_fair">Fair</label>
                        </div>
                    </div>
                </div>

                <!-- Rating Filter -->
                <div class="filter-section">
                    <div class="filter-header">
                        <span class="filter-title">Rating</span>
                        <button class="clear-filter" onclick="clearFilter('rating')">Clear</button>
                    </div>
                    <div class="filter-options">
                        <div class="filter-option rating-option">
                            <input type="radio" name="rating" value="5">
                            <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                            <label>& up</label>
                        </div>
                        <div class="filter-option rating-option">
                            <input type="radio" name="rating" value="4">
                            <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span>
                            <label>& up</label>
                        </div>
                        <div class="filter-option rating-option">
                            <input type="radio" name="rating" value="3">
                            <span class="stars">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span>
                            <label>& up</label>
                        </div>
                    </div>
                </div>

                <!-- Special Filters -->
                <div class="filter-section">
                    <div class="filter-header">
                        <span class="filter-title">Special Filters</span>
                    </div>
                    <div class="filter-options">
                        <div class="filter-option">
                            <input type="checkbox" id="featured">
                            <label for="featured">Featured</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="boosted">
                            <label for="boosted">Boosted</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="negotiable">
                            <label for="negotiable">Negotiable Price</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="verified">
                            <label for="verified">Verified Sellers</label>
                        </div>
                    </div>
                </div>

                <button class="apply-filters" onclick="applyFilters()">
                    Apply Filters
                </button>
            </aside>

            <!-- Products Section -->
            <main class="products-section">
                <!-- Results Bar -->
                <div class="results-bar">
                    <div class="results-count" id="resultsCount">
                        Loading products...
                    </div>
                    <div class="sort-options">
                        <label for="sortBy">Sort by:</label>
                        <select id="sortBy" class="sort-select" onchange="applyFilters()">
                            <option value="-created_at">Newest First</option>
                            <option value="created_at">Oldest First</option>
                            <option value="price">Price: Low to High</option>
                            <option value="-price">Price: High to Low</option>
                            <option value="-views_count">Most Viewed</option>
                            <option value="-favorites_count">Most Popular</option>
                        </select>
                    </div>
                </div>

                <!-- Active Filters -->
                <div class="active-filters" id="activeFilters">
                    <!-- Active filter tags shown here -->
                </div>

                <!-- Product Grid -->
                <div class="product-grid" id="productGrid">
                    <!-- Loading state -->
                    <div class="loading" style="grid-column: 1/-1;">
                        <div class="spinner"></div>
                        <p>Loading products...</p>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="pagination" id="pagination">
                    <!-- Pagination buttons loaded dynamically -->
                </div>
            </main>
        </div>
    </div>

    <script>
        const API_BASE_URL = '/api';
        let currentPage = 1;
        let totalPages = 1;
        let currentView = 'grid';
        let activeFilters = {
            categories: [],
            locations: [],
            conditions: [],
            minPrice: null,
            maxPrice: null,
            rating: null,
            featured: false,
            boosted: false,
            negotiable: false,
            verified: false,
            search: ''
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            updateCartBadge();
            await loadCategories();
            await loadLocations();
            parseURLParams();
            await loadProducts();
        });

        // Parse URL parameters
        function parseURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.has('search')) {
                activeFilters.search = urlParams.get('search');
                document.getElementById('searchInput').value = activeFilters.search;
            }
            
            if (urlParams.has('category')) {
                activeFilters.categories = [urlParams.get('category')];
            }
            
            if (urlParams.has('featured')) {
                activeFilters.featured = true;
                document.getElementById('featured').checked = true;
            }
            
            if (urlParams.has('sort')) {
                document.getElementById('sortBy').value = urlParams.get('sort');
            }
        }

        // Load categories
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE_URL}/market/categories/`);
                const categories = await response.json();
                
                const container = document.getElementById('categoryFilters');
                container.innerHTML = '';
                
                categories.forEach(cat => {
                    const option = document.createElement('div');
                    option.className = 'filter-option';
                    option.innerHTML = `
                        <input type="checkbox" id="cat_${cat.slug}" value="${cat.slug}" 
                               ${activeFilters.categories.includes(cat.slug) ? 'checked' : ''}>
                        <label for="cat_${cat.slug}">${cat.icon} ${cat.name}</label>
                    `;
                    container.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Load locations
        async function loadLocations() {
            try {
                const response = await fetch(`${API_BASE_URL}/market/locations/`);
                const locations = await response.json();
                
                const container = document.getElementById('locationFilters');
                container.innerHTML = '';
                
                // Group by state
                const states = {};
                locations.forEach(loc => {
                    if (!states[loc.state]) {
                        states[loc.state] = [];
                    }
                    states[loc.state].push(loc);
                });
                
                Object.keys(states).forEach(state => {
                    const option = document.createElement('div');
                    option.className = 'filter-option';
                    option.innerHTML = `
                        <input type="checkbox" id="loc_${state}" value="${state}">
                        <label for="loc_${state}">${state}</label>
                        <span class="filter-count">(${states[state].length})</span>
                    `;
                    container.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }

        // Load products
        async function loadProducts() {
            try {
                const params = new URLSearchParams();
                
                // Pagination
                params.append('page', currentPage);
                params.append('limit', 20);
                
                // Sorting
                const sortBy = document.getElementById('sortBy').value;
                if (sortBy) params.append('ordering', sortBy);
                
                // Search
                if (activeFilters.search) {
                    params.append('search', activeFilters.search);
                }
                
                // Category filter
                if (activeFilters.categories.length > 0) {
                    activeFilters.categories.forEach(cat => {
                        params.append('category', cat);
                    });
                }
                
                // Location filter
                if (activeFilters.locations.length > 0) {
                    activeFilters.locations.forEach(loc => {
                        params.append('state', loc);
                    });
                }
                
                // Condition filter
                if (activeFilters.conditions.length > 0) {
                    activeFilters.conditions.forEach(cond => {
                        params.append('condition', cond);
                    });
                }
                
                // Price range
                if (activeFilters.minPrice) {
                    params.append('min_price', activeFilters.minPrice);
                }
                if (activeFilters.maxPrice) {
                    params.append('max_price', activeFilters.maxPrice);
                }
                
                // Special filters
                if (activeFilters.featured) {
                    params.append('is_featured', 'true');
                }
                if (activeFilters.boosted) {
                    params.append('is_boosted', 'true');
                }
                if (activeFilters.negotiable) {
                    params.append('negotiable', 'true');
                }
                
                const response = await fetch(`${API_BASE_URL}/market/products/?${params}`);
                const data = await response.json();
                
                renderProducts(data.results || data);
                updatePagination(data);
                updateResultsCount(data);
                updateActiveFilters();
            } catch (error) {
                console.error('Error loading products:', error);
                showEmptyState('Error loading products. Please try again.');
            }
        }

        // Render products
        function renderProducts(products) {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = '';
            
            if (!products || products.length === 0) {
                showEmptyState('No products found matching your criteria.');
                return;
            }
            
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = `product-card ${currentView === 'list' ? 'list-view' : ''}`;
                card.innerHTML = `
                    ${product.is_featured ? '<div class="product-badge">‚≠ê Featured</div>' : ''}
                    ${product.is_boosted ? '<div class="product-badge">üî• Boosted</div>' : ''}
                    <button class="wishlist-btn" onclick="toggleWishlist('${product.id}', event)">
                        ${product.is_favorited ? '‚ù§Ô∏è' : 'ü§ç'}
                    </button>
                    <img src="${product.primary_image || 'https://via.placeholder.com/280x250/1a2332/ffffff?text=No+Image'}" 
                         alt="${product.title}" class="product-image" onclick="viewProduct('${product.slug}', event)">
                    <div class="product-info">
                        <h3 class="product-title">${product.title}</h3>
                        <p class="product-category">${product.category_name || 'Uncategorized'}</p>
                        <p class="product-location">üìç ${product.location_display || 'Location not specified'}</p>
                        <div class="product-rating">
                            <span class="stars">${'‚òÖ'.repeat(Math.round(product.average_rating || 0))}${'‚òÜ'.repeat(5 - Math.round(product.average_rating || 0))}</span>
                            <span class="review-count">(${product.review_count || 0} reviews)</span>
                        </div>
                        <div class="product-price">
                            ‚Ç¶${parseFloat(product.price).toLocaleString()}
                            ${product.negotiable ? '<span class="negotiable-tag">üí¨ Negotiable</span>' : ''}
                        </div>
                        <div class="product-actions">
                            <button class="add-to-cart" onclick="addToCart('${product.id}', event)">
                                Add to Cart
                            </button>
                            <button class="quick-view" onclick="viewProduct('${product.slug}', event)">
                                View
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Show empty state
        function showEmptyState(message) {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = `
                <div class="empty-state" style="grid-column: 1/-1;">
                    <div class="empty-icon">üì¶</div>
                    <h2>No Products Found</h2>
                    <p>${message}</p>
                    <button class="apply-filters" onclick="clearAllFilters()">
                        Clear All Filters
                    </button>
                </div>
            `;
        }

        // Update pagination
        function updatePagination(data) {
            totalPages = data.total_pages || 1;
            const container = document.getElementById('pagination');
            container.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'page-btn';
            prevBtn.textContent = '‚Üê Previous';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => changePage(currentPage - 1);
            container.appendChild(prevBtn);
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => changePage(i);
                    container.appendChild(pageBtn);
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    dots.style.padding = '0.75rem';
                    container.appendChild(dots);
                }
            }
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'page-btn';
            nextBtn.textContent = 'Next ‚Üí';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => changePage(currentPage + 1);
            container.appendChild(nextBtn);
        }

        // Change page
        function changePage(page) {
            currentPage = page;
            loadProducts();
            window.scrollTo(0, 0);
        }

        // Update results count
        function updateResultsCount(data) {
            const count = data.count || data.length || 0;
            const start = (currentPage - 1) * 20 + 1;
            const end = Math.min(currentPage * 20, count);
            
            document.getElementById('resultsCount').textContent = 
                `Showing ${start}-${end} of ${count} products`;
        }

        // Update active filters display
        function updateActiveFilters() {
            const container = document.getElementById('activeFilters');
            container.innerHTML = '';
            
            if (activeFilters.search) {
                addFilterTag('Search', activeFilters.search, () => {
                    activeFilters.search = '';
                    document.getElementById('searchInput').value = '';
                });
            }
            
            activeFilters.categories.forEach(cat => {
                addFilterTag('Category', cat, () => {
                    activeFilters.categories = activeFilters.categories.filter(c => c !== cat);
                });
            });
            
            activeFilters.conditions.forEach(cond => {
                addFilterTag('Condition', cond, () => {
                    activeFilters.conditions = activeFilters.conditions.filter(c => c !== cond);
                });
            });
            
            if (activeFilters.minPrice || activeFilters.maxPrice) {
                const priceText = `‚Ç¶${activeFilters.minPrice || 0} - ‚Ç¶${activeFilters.maxPrice || '‚àû'}`;
                addFilterTag('Price', priceText, () => {
                    activeFilters.minPrice = null;
                    activeFilters.maxPrice = null;
                    document.getElementById('minPrice').value = '';
                    document.getElementById('maxPrice').value = '';
                });
            }
        }

        // Add filter tag
        function addFilterTag(label, value, removeCallback) {
            const container = document.getElementById('activeFilters');
            const tag = document.createElement('div');
            tag.className = 'filter-tag';
            tag.innerHTML = `
                <span>${label}: ${value}</span>
                <button class="remove-filter">√ó</button>
            `;
            tag.querySelector('.remove-filter').onclick = () => {
                removeCallback();
                applyFilters();
            };
            container.appendChild(tag);
        }

        // Apply filters
        function applyFilters() {
            // Get selected categories
            activeFilters.categories = Array.from(document.querySelectorAll('#categoryFilters input:checked'))
                .map(input => input.value);
            
            // Get selected locations
            activeFilters.locations = Array.from(document.querySelectorAll('#locationFilters input:checked'))
                .map(input => input.value);
            
            // Get selected conditions
            activeFilters.conditions = Array.from(document.querySelectorAll('input[id^="cond_"]:checked'))
                .map(input => input.value);
            
            // Get price range
            activeFilters.minPrice = document.getElementById('minPrice').value || null;
            activeFilters.maxPrice = document.getElementById('maxPrice').value || null;
            
            // Get rating
            const ratingInput = document.querySelector('input[name="rating"]:checked');
            activeFilters.rating = ratingInput ? ratingInput.value : null;
            
            // Get special filters
            activeFilters.featured = document.getElementById('featured').checked;
            activeFilters.boosted = document.getElementById('boosted').checked;
            activeFilters.negotiable = document.getElementById('negotiable').checked;
            activeFilters.verified = document.getElementById('verified').checked;
            
            currentPage = 1;
            loadProducts();
            
            // Close mobile filters
            if (window.innerWidth <= 1024) {
                toggleMobileFilters();
            }
        }

        // Clear specific filter
        function clearFilter(type) {
            switch(type) {
                case 'category':
                    activeFilters.categories = [];
                    document.querySelectorAll('#categoryFilters input').forEach(input => input.checked = false);
                    break;
                case 'location':
                    activeFilters.locations = [];
                    document.querySelectorAll('#locationFilters input').forEach(input => input.checked = false);
                    break;
                case 'condition':
                    activeFilters.conditions = [];
                    document.querySelectorAll('input[id^="cond_"]').forEach(input => input.checked = false);
                    break;
                case 'price':
                    activeFilters.minPrice = null;
                    activeFilters.maxPrice = null;
                    document.getElementById('minPrice').value = '';
                    document.getElementById('maxPrice').value = '';
                    break;
                case 'rating':
                    activeFilters.rating = null;
                    document.querySelectorAll('input[name="rating"]').forEach(input => input.checked = false);
                    break;
            }
            applyFilters();
        }

        // Clear all filters
        function clearAllFilters() {
            activeFilters = {
                categories: [],
                locations: [],
                conditions: [],
                minPrice: null,
                maxPrice: null,
                rating: null,
                featured: false,
                boosted: false,
                negotiable: false,
                verified: false,
                search: ''
            };
            
            // Reset all inputs
            document.querySelectorAll('.filter-option input').forEach(input => input.checked = false);
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            document.getElementById('searchInput').value = '';
            
            applyFilters();
        }

        // Perform search
        function performSearch() {
            activeFilters.search = document.getElementById('searchInput').value;
            currentPage = 1;
            loadProducts();
        }

        // Set view mode
        function setView(view) {
            currentView = view;
            const grid = document.getElementById('productGrid');
            
            if (view === 'list') {
                grid.classList.add('list-view');
            } else {
                grid.classList.remove('list-view');
            }
            
            // Update button states
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Re-render products with new view
            loadProducts();
        }

        // Toggle mobile filters
        function toggleMobileFilters() {
            const sidebar = document.getElementById('filtersSidebar');
            const overlay = document.getElementById('filtersOverlay');
            const closeBtn = sidebar.querySelector('.close-filters');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
            
            if (sidebar.classList.contains('active')) {
                closeBtn.style.display = 'block';
            } else {
                closeBtn.style.display = 'none';
            }
        }

        // Add to cart
        function addToCart(productId, event) {
            event.stopPropagation();
            
            fetch(`${API_BASE_URL}/cart/add/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_id: productId, quantity: 1 })
            })
            .then(res => res.json())
            .then(data => {
                alert('‚úÖ Product added to cart!');
                updateCartBadge();
            })
            .catch(error => {
                console.error('Error adding to cart:', error);
                alert('‚ùå Error adding to cart');
            });
        }

        // Toggle wishlist
        function toggleWishlist(productId, event) {
            event.stopPropagation();
            
            fetch(`${API_BASE_URL}/market/products/${productId}/favorite/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                loadProducts();
            })
            .catch(error => console.error('Error toggling wishlist:', error));
        }

        // View product
        function viewProduct(slug, event) {
            event.stopPropagation();
            window.location.href = `/product-detail.html?slug=${slug}`;
        }

        // Update cart badge
        function updateCartBadge() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            document.getElementById('cartCount').textContent = cart.length;
        }

        // Toggle user menu
        function toggleUserMenu() {
            const token = localStorage.getItem('authToken');
            if (token) {
                window.location.href = '/account.html';
            } else {
                window.location.href = '/login.html';
            }
        }

        // Handle search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    </script>
</body>
</html>
